package org.yousense.common;

import android.content.Context;
import android.content.SharedPreferences;
import android.provider.Settings;
import org.apache.commons.codec.binary.Hex;

import java.security.SecureRandom;

/**
 * Users are identified by ANDROID_ID + randomly generated bytes.
 *
 * ANDROID_ID and random parts are both 16 hex chars (64 bits) long, in total 32 hex chars.
 *
 * Shortening either is a bad idea because of the Birthday Problem.
 * With 32-bit ID parts, the probability of collision is:
 *   0.0012% with 1000 users,
 *   1.2% with 10k users,
 *   69% with 100k users.
 * With 64-bit ID parts, the probability of collision is still 10^-6 for 10M people.
 */
public class UserId {
    static final String PREFS_FILE = "identity";
    static final String USER_ID = "userid";
    static final int USER_ID_RANDOM_HEX_LENGTH = 16;

    private static String cachedId;

    // Public API

    /**
     * Get the persistent 32-hex-char user ID.
     */
    public static synchronized String userId(Context context) {
        if (cachedId == null) {
            cachedId = readStoredUserId(context);
            if (cachedId == null) {
                cachedId = writeRandomUserId(context);
            }
        }
        return cachedId;
    }

    // Dangerous package API - if you are using it outside of tests, you are probably doing something wrong.

    /**
     * Resets the randomly generated portion of the UserId.
     * This is done by erasing the stored value from disk.
     */
    static synchronized void resetRandomId(Context context) {
        SharedPreferences.Editor editor = context.getSharedPreferences(PREFS_FILE, 0).edit();
        editor.clear();
        editor.commit();
        cachedId = null;
    }

    static synchronized void clearCache() {
        cachedId = null;
    }

    private static synchronized String readStoredUserId(Context context) {
        SharedPreferences prefs = context.getSharedPreferences(PREFS_FILE, 0);
        return prefs.getString(USER_ID, null);
    }

    private static synchronized String writeRandomUserId(Context context) {
        byte[] random = new byte[USER_ID_RANDOM_HEX_LENGTH / 2];
        new SecureRandom().nextBytes(random);

        String newId = (androidId(context) + new String(Hex.encodeHex(random))).toLowerCase();

        SharedPreferences prefs = context.getSharedPreferences(PREFS_FILE, 0);
        SharedPreferences.Editor editor = prefs.edit();
        editor.putString(USER_ID, newId);
        editor.commit();
        return newId;
    }

    public static synchronized String androidId(Context context) {
        String aid = Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID);
        // Known duplicate ID: http://code.google.com/p/android/issues/detail?id=10603
        if (aid == null || "9774d56d682e549c".equals(aid)) {
            return "0000000000000000";
        } else {
            return aid.toLowerCase();
        }
    }

}
